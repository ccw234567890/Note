
# 4.4 Covariance and Correlation (协方差与相关性)

> [!abstract] 📝 课程概要
> 上节课我们学习了**矩 (Moments)** 和 **矩母函数 (MGF)**。今天我们进入 4.4 章节，学习两个用于衡量**两个随机变量之间关系**的重要概念：
> 1.  **协方差 (Covariance)**：衡量两个变量如何协同变化。
> 2.  **相关系数 (Correlation)**：协方差的标准化形式，衡量线性关系的强弱。
> 
> **⚠️ 教授提示**：这部分内容计算繁琐（涉及二重积分），逻辑紧密（如柯西-施瓦茨不等式的证明），且是后续学习的基础，请务必亲自推导一遍所有公式。

---

## 1. 协方差 (Covariance)

### 1.1 直观引入 (Intuition)
> [!example] 💡 例子：标准化考试成绩
> 想象一个学生参加两门考试：**Verbal (语文)** 和 **Quantitative (数学)**。
> * 设 $X$ 为语文成绩，$Y$ 为数学成绩。
> * 通常我们认为，如果一个学生比较聪明或努力，他在两门课上的表现应该有某种**联系**。
>     * 如果 $X$ 高，我们预期 $Y$ 也可能比较高（正相关）。
>     * 或者在某些特定群体中，偏科严重，$X$ 高时 $Y$ 反而低（负相关）。
> * 我们需要一个量化指标来描述这种**“高分伴随高分”**或**“高分伴随低分”**的程度，这就是协方差的意义。

### 1.2 定义 (Definition)
> [!NOTE] 📌 定义：协方差
> 设 $X$ 和 $Y$ 是两个联合分布的随机变量，且它们的方差有限。
> 令 $\mu_X = E(X)$，$\mu_Y = E(Y)$。
> $X$ 和 $Y$ 的协方差记为 $Cov(X, Y)$，定义为：
> $$
> Cov(X, Y) = E[(X - \mu_X)(Y - \mu_Y)]
> $$

* **物理意义**：
    * $(X - \mu_X)$ 和 $(Y - \mu_Y)$ 分别代表 $X$ 和 $Y$ **偏离均值的方向和程度**。
    * 如果 $X$ 和 $Y$ 倾向于**同时大于**均值（$(+)\times(+)>0$）或**同时小于**均值（$(-)\times(-)>0$），则协方差为**正**。
    * 如果一个大于均值时另一个倾向于小于均值（$(+)\times(-)<0$），则协方差为**负**。

### 1.3 计算公式 (Computational Formula)
直接使用定义计算通常很麻烦，我们常用以下简化公式：

> [!tip] ⚡ 常用计算定理 (Theorem 4.6.1)
> $$
> Cov(X, Y) = E(XY) - E(X)E(Y)
> $$

**证明 (Proof)**：
利用期望的线性性质：
$$
\begin{aligned}
Cov(X, Y) &= E[(X - \mu_X)(Y - \mu_Y)] \\
&= E[XY - X\mu_Y - Y\mu_X + \mu_X\mu_Y] \quad \text{(展开多项式)} \\
&= E(XY) - \mu_Y E(X) - \mu_X E(Y) + \mu_X\mu_Y \quad \text{(期望的线性)} \\
&= E(XY) - \mu_Y \mu_X - \mu_X \mu_Y + \mu_X\mu_Y \quad \text{(代入 } E(X)=\mu_X, E(Y)=\mu_Y) \\
&= E(XY) - E(X)E(Y) \quad \text{(合并同类项)}
\end{aligned}
$$

---

## 2. 计算实例详解 (Example 4.6.2)

> [!question] ❓ 课堂例题
> 设联合概率密度函数 (Joint PDF) 为：
> $$f(x, y) = \begin{cases} 2xy + \frac{1}{2}, & 0 \le x \le 1, 0 \le y \le 1 \\ 0, & \text{otherwise} \end{cases}$$
> 求 $Cov(X, Y)$。

**解题思路**：我们需要找出 $E(XY)$，$E(X)$ 和 $E(Y)$。

**步骤 1：求边缘概率密度 (Marginal PDFs)**
为了求 $E(X)$，先求 $f_X(x)$：
$$
f_X(x) = \int_{-\infty}^{\infty} f(x, y) dy = \int_{0}^{1} (2xy + \frac{1}{2}) dy
$$
$$
= \left[ xy^2 + \frac{1}{2}y \right]_{y=0}^{y=1} = (x + \frac{1}{2}) - 0 = x + \frac{1}{2}, \quad 0 \le x \le 1
$$
同理（由于对称性）：
$$f_Y(y) = y + \frac{1}{2}, \quad 0 \le y \le 1$$

**步骤 2：求期望 $E(X)$ 和 $E(Y)$**
$$
\mu_X = E(X) = \int_{0}^{1} x \cdot f_X(x) dx = \int_{0}^{1} x(x + \frac{1}{2}) dx
$$
$$
= \int_{0}^{1} (x^2 + \frac{1}{2}x) dx = \left[ \frac{x^3}{3} + \frac{x^2}{4} \right]_0^1 = \frac{1}{3} + \frac{1}{4} = \frac{7}{12}
$$
同理，$\mu_Y = \frac{7}{12}$。

**步骤 3：求 $E(XY)$**
$$
E(XY) = \int_{0}^{1} \int_{0}^{1} xy \cdot f(x, y) dx dy = \int_{0}^{1} \int_{0}^{1} xy(2xy + \frac{1}{2}) dx dy
$$
$$
= \int_{0}^{1} \int_{0}^{1} (2x^2y^2 + \frac{1}{2}xy) dx dy
$$
先对 $x$ 积分：
$$
= \int_{0}^{1} \left[ \frac{2}{3}x^3y^2 + \frac{1}{4}x^2y \right]_{x=0}^{1} dy = \int_{0}^{1} (\frac{2}{3}y^2 + \frac{1}{4}y) dy
$$
再对 $y$ 积分：
$$
= \left[ \frac{2}{9}y^3 + \frac{1}{8}y^2 \right]_0^1 = \frac{2}{9} + \frac{1}{8} = \frac{16+9}{72} = \frac{25}{72}
$$

**步骤 4：计算协方差**
$$
Cov(X, Y) = E(XY) - E(X)E(Y) = \frac{25}{72} - \left(\frac{7}{12}\right)\left(\frac{7}{12}\right)
$$
$$
= \frac{25}{72} - \frac{49}{144} = \frac{50}{144} - \frac{49}{144} = \frac{1}{144}
$$

---

## 3. 相关系数 (Correlation)

协方差的值依赖于单位（Scaling）。为了标准化这个关系，我们引入相关系数。

### 3.1 定义
> [!NOTE] 📌 定义：相关系数 $\rho$
> $$
> \rho(X, Y) = \frac{Cov(X, Y)}{\sigma_X \sigma_Y}
> $$
> 其中 $\sigma_X$ 和 $\sigma_Y$ 是标准差。本质上，这是协方差的**Rescaling（尺度重缩放）**。

### 3.2 取值范围与证明 (Cauchy-Schwarz Inequality)

**定理**：$-1 \le \rho(X, Y) \le 1$。
为了证明这一点，我们需要用到著名的 **柯西-施瓦茨不等式 (Schwarz Inequality)**。

> [!important] 📜 柯西-施瓦茨不等式
> 对于随机变量 $U, V$，有：
> $$ [E(UV)]^2 \le E(U^2)E(V^2) $$
> 当且仅当 $U$ 和 $V$ 存在线性关系（$aU + bV = 0$）时等号成立。

**证明思路 (Proof Idea)**：
1.  构造二次函数：考虑 $g(t) = E[(U + tV)^2]$。
2.  非负性：无论 $t$ 取何值，$(U+tV)^2 \ge 0$，所以期望 $g(t) \ge 0$。
3.  展开：$g(t) = E(U^2) + 2tE(UV) + t^2E(V^2) \ge 0$。
4.  判别式：这是一个关于 $t$ 的二次函数，要恒大于等于0，其判别式 $\Delta$ 必须小于等于0。
    $$ \Delta = (2E(UV))^2 - 4E(V^2)E(U^2) \le 0 $$
    $$ 4[E(UV)]^2 \le 4E(U^2)E(V^2) \implies [E(UV)]^2 \le E(U^2)E(V^2) $$

**应用到相关系数**：
令 $U = X - \mu_X$, $V = Y - \mu_Y$。
则不等式变为 $[Cov(X, Y)]^2 \le \sigma_X^2 \sigma_Y^2$。
两边开方并整理得：
$$ \left| \frac{Cov(X, Y)}{\sigma_X \sigma_Y} \right| \le 1 \implies -1 \le \rho \le 1 $$

### 3.3 相关性的分类
* **$\rho > 0$**：正相关 (Positively correlated)。
* **$\rho < 0$**：负相关 (Negatively correlated)。
* **$\rho = 0$**：不相关 (Uncorrelated)。
* **$\rho = \pm 1$**：完全线性相关 (Perfectly linear relationship)。

---

## 4. 独立性 vs 不相关性 (Independence vs Uncorrelated)

这是考试中的**高频易错点**，请务必区分清楚。

> [!example] ⚔️ 核心对比
> 1.  **独立 $\Rightarrow$ 不相关**：
>     如果 $X, Y$ 独立，则 $E(XY) = E(X)E(Y)$，代入协方差公式得 $Cov(X, Y) = 0$，即 $\rho = 0$。
> 
> 2.  **不相关 $\nRightarrow$ 独立**：
>     如果 $\rho = 0$，两个变量**不一定**独立。它们可能存在**非线性**的依赖关系。

### 反例 1：离散型 (Dependent but Uncorrelated)
* 设 $X$ 在 $\{-1, 0, 1\}$ 上均匀分布（概率各为 $1/3$）。
* 设 $Y = X^2$。显然 $Y$ 完全依赖于 $X$ (**Dependent**)。
* 计算协方差：
    * $E(X) = (-1)\frac{1}{3} + 0 + 1\frac{1}{3} = 0$
    * $XY = X \cdot X^2 = X^3$。$X^3$ 的取值也是 $\{-1, 0, 1\}$。
    * $E(XY) = E(X^3) = (-1)^3\frac{1}{3} + 0 + 1^3\frac{1}{3} = 0$
    * $Cov(X, Y) = E(XY) - E(X)E(Y) = 0 - 0 = 0$。
* **结论**：协方差为0（不相关），但显然是不独立的。

### 反例 2：连续型 (极坐标计算案例)
* 设 $(X, Y)$ 在单位圆 $x^2 + y^2 \le 1$ 内均匀分布。$f(x, y) = \frac{1}{\pi}$。
* 由于定义域是圆，X的取值范围受Y限制，所以它们**不独立**。
* **计算 $E(XY)$**：使用极坐标变换 (Polar Coordinates)。
    * $x = r\cos\theta, y = r\sin\theta$
    * $dx dy = r dr d\theta$ (**注意 Jacobian 系数 r**)
    $$
    E(XY) = \int_{0}^{2\pi} \int_{0}^{1} (r\cos\theta)(r\sin\theta) \cdot \frac{1}{\pi} \cdot r dr d\theta
    $$
    $$
    = \frac{1}{\pi} \left( \int_{0}^{1} r^3 dr \right) \left( \int_{0}^{2\pi} \sin\theta\cos\theta d\theta \right)
    $$
    由于 $\int_{0}^{2\pi} \frac{1}{2}\sin(2\theta) d\theta = 0$，所以 $E(XY)=0$。
    同理由于对称性，$E(X)=0, E(Y)=0$。
* **结论**：$Cov(X, Y) = 0$，即不相关，但它们不独立。

---

## 5. 协方差与方差的性质 (Properties)

这些性质在计算复杂变量和的方差时非常有用：

1.  **线性变换**：
    $$ Cov(aX + b, cY + d) = ac \cdot Cov(X, Y) $$
    *(常数项 $b, d$ 不影响协方差，只有乘法系数 $a, c$ 会提取出来)*

2.  **和的方差**：
    > [!warning] 重要公式
    > $$ Var(X + Y) = Var(X) + Var(Y) + 2Cov(X, Y) $$
    > 只有当 $X, Y$ **不相关**（$Cov=0$）时，才有 $Var(X+Y) = Var(X) + Var(Y)$。

3.  **推广到多个变量**：
    $$ Var\left( \sum_{i=1}^{n} X_i \right) = \sum_{i=1}^{n} Var(X_i) + 2 \sum_{1 \le i < j \le n} Cov(X_i, X_j) $$

---

> [!summary] 📚 课后行动指南
> 1.  **复习计算**：务必亲手计算一遍 Example 4.6.2，特别是二重积分的部分。
> 2.  **理解概念**：深刻理解“独立”和“不相关”的区别，记住那个 $Y=X^2$ 的反例。
> 3.  **预习**：下节课难度会继续增加，请确保理解了今天的“矩母函数”和“协方差”基础。