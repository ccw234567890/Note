![[85d9e41eb70912aee781bc37912f789.jpg]]![[bff8ecb5e74998d1997c3519aa927d3.jpg]]
![[522758d493ea4dee07eb3e5ba1816f0.jpg]]
![[b85411fe44bd879c7562978876b1495.jpg]]

# 笔记：SPI (Serial Peripheral Interface) 通信协议全解析

> [!abstract] 核心纲要
> 本笔记旨在深入剖析**SPI (串行外设接口)** 的核心概念与工作原理。我们将重点关注：
> 1.  **SPI的硬件连接**: 理解其经典的**四线制**结构（MOSI, MISO, SCLK, SS）。
> 2.  **SPI的数据传输流程**: 解析主从设备之间全双工通信的步骤。
> 3.  **SPI的四种工作模式**: 详细阐述 **CPOL (时钟极性)** 和 **CPHA (时钟相位)** 的组合与作用。
> 4.  **SPI的优缺点**及其广泛的**应用场景**。

---

### Ⅰ. SPI是什么？- 高速、全双工的串行总线

> [!info]
> **SPI (Serial Peripheral Interface)** 是一种**高速、全双工、同步**的串行通信协议。它采用**主从 (Master-Slave)** 架构，通常用于微控制器（MCU）与外围设备（如传感器、存储器、显示屏）之间的短距离通信。

---

### Ⅱ. SPI的硬件连接：经典的四线制

> [!example]
> 标准的SPI通信需要使用四根信号线来连接一个主设备和一个或多个从设备。

> [!check] **四根线的职责**
> 1. **SCLK (Serial Clock)**: **串行时钟**。由**主设备**产生，用于同步数据的传输，决定了通信的速率。
> 2. **MOSI (Master Out, Slave In)**: **主出从入**。数据**从主设备流向从设备**的通道。
> 3. **MISO (Master In, Slave Out)**: **主入从出**。数据**从从设备流回主设备**的通道。
> 4. **SS / CS (Slave Select / Chip Select)**: **从设备选择**。由**主设备**控制。当主设备想与某个从设备通信时，会将其对应的SS线拉为**低电平**来“激活”它。

> [!tip] **菊花链连接 (Daisy-Chain SPI Bus)**
> > 当主设备需要连接多个从设备，但片选引脚（SS）不足时，可以使用“菊花链”模式。所有从设备共享一个SS引脚，一个从设备的输出（MISO）连接到下一个从设备的输入（MOSI），形成一个长长的移位寄存器链。

---

### Ⅲ. SPI的数据传输流程

> [!help]
> SPI的数据传输可以看作是主从设备内部的两个**移位寄存器**在进行数据交换。

**基本传输步骤**:
1.  **选择从设备**: 主设备将目标从设备的 **SS/CS 线拉为低电平**，选中该设备。
2.  **主设备发送**: 主设备在 **SCLK** 线上产生时钟脉冲。在每个时钟周期的特定边沿，主设备将一位数据推到 **MOSI** 线上。
3.  **从设备接收**: 在同一个时钟边沿，从设备从 **MOSI** 线上读取这一位数据。
4.  **从设备发送 (同时进行)**: **与此同时**，从设备也将自己的一位数据推到 **MISO** 线上。
5.  **主设备接收 (同时进行)**: 主设备在同一个时钟边沿，从 **MISO** 线上读取这一位数据。

> [!success] **全双工 (Full-duplex)**
> > 第3、4、5步是**同时发生**的。主设备在发送一位数据的同时，也在接收一位数据。这种“边说边听”的能力，就是SPI**全双工**特性的体现，也是其高速的原因之一。

---

### Ⅳ. SPI的四种工作模式 (CPOL & CPHA)

> [!question]
> 主从设备必须就“**何时**发送和**何时**读取数据”达成一致。这个“何时”由**时钟极性(CPOL)**和**时钟相位(CPHA)**两个参数共同决定，它们组合成了四种SPI模式。

> [!note] **CPOL (Clock Polarity) - 时钟极性**
> > - **定义**: 决定了SCLK时钟信号在**空闲状态**（即SS为高电平时）的电平。
> > - **`CPOL = 0`**: 空闲时为**低电平**，第一个有效边沿是**上升沿**。
> > - **`CPOL = 1`**: 空闲时为**高电平**，第一个有效边沿是**下降沿**。

> [!note] **CPHA (Clock Phase) - 时钟相位**
> > - **定义**: 决定了数据是在时钟周期的**哪一个边沿**被**采样（读取）**。
> > - **`CPHA = 0`**: 数据在**第一个**有效边沿被采样。
> > - **`CPHA = 1`**: 数据在**第二个**有效边沿被采样。

> [!check] **四种模式总结**
| 模式 | CPOL | CPHA | 描述 (数据在哪个边沿被采样) |
| :--- | :--- | :--- | :--- |
| **Mode 0** | 0 | 0 | 在SCLK的**第一个边沿（上升沿）**采样 |
| **Mode 1** | 0 | 1 | 在SCLK的**第二个边沿（下降沿）**采样 |
| **Mode 2** | 1 | 0 | 在SCLK的**第一个边沿（下降沿）**采样 |
| **Mode 3** | 1 | 1 | 在SCLK的**第二个边沿（上升沿）**采样 |
>
> **关键**: **主设备和从设备必须配置成完全相同的SPI模式才能正常通信！**

---

### Ⅴ. SPI的优缺点

> [!summary]

> [!check] **优点 (Advantages)**
> - **全双工通信 (Full-duplex)**: 可以同时发送和接收数据。
> - **高吞吐量 (Higher throughput)**: 协议简单，没有太多开销，通常比I²C快得多。
> - **协议灵活 (Complete protocol flexibility)**: 数据传输的位数和格式可以灵活定义。
> - **硬件简单，功耗较低 (Low power requirements)**。

> [!danger] **缺点 (Disadvantages)**
> - **需要更多引脚 (Four wires+)**: 相比I²C的两根线，SPI至少需要四根线。
> - **没有应答机制 (No acknowledgement)**: 主设备无法确认从设备是否成功收到了数据。
> - **没有内置寻址**: 在标准模式下，每个从设备都需要一根独立的SS线，从设备多时会占用大量引脚。
> - **只支持单主设备 (Only allows for a single master)**。

---

### Ⅵ. SPI的典型应用

> [!list]
> SPI因其高速特性，被广泛用于需要大数据量、高速度传输的场景：
> - **传感器 (Sensors)**: 温度、压力、加速度计等。
> - **存储设备 (Storage)**: **SD卡**、Flash闪存、EEPROM。
> - **控制设备 (Control devices)**: 音频编解码器 (Audio codecs)、数模转换器 (DAC)。
> - **显示设备 (LCD displays)**: 驱动TFT-LCD屏幕。
> - **实时时钟 (Real-time clocks)**。