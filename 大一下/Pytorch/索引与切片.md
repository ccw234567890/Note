# PyTorch 张量选择与索引操作学习笔记

#PyTorch #深度学习 #张量操作 #笔记

> [!info] 基础张量
> 为了方便理解，本笔记中的许多操作都将基于以下这个四维张量 `a`：
> ```python
> a = torch.rand(4, 3, 28, 28)
> ```
> 你可以将其想象为：一个包含 **4 张图片**的小批量 (mini-batch)，每张图片是 **3 通道** (如 RGB)，尺寸为 **28x28** 像素。

---

## 1. 📌 基本索引 (Basic Indexing)
这是最直接的选取方式，通过提供每个维度的具体索引来定位一个或一组元素。

> [!example] 代码示例分析
> ```python
> # 初始张量形状: (4, 3, 28, 28)
> a = torch.rand(4, 3, 28, 28)
> 
> # 选取第 0 维中索引为 0 的元素 (第1张图片)
> # 维度从 4D -> 3D
> a[0].shape 
> # 输出: torch.Size([3, 28, 28])
> 
> # 继续选取新张量中第 0 维中索引为 0 的元素 (第1张图片的第1个通道)
> # 维度从 3D -> 2D
> a[0, 0].shape
> # 输出: torch.Size([28, 28])
> 
> # 为所有维度提供确切索引，定位到单个值
> # 维度从 4D -> 0D (标量)
> a[0, 0, 2, 4]
> # 输出: tensor(0.8082) 
> ```

> [!tip] 核心要点
> - 每使用一个整数进行索引，张量的维度 (rank) 就会**减少一**。
> - 可以像 `a[idx1, idx2, ...]` 这样连续索引，一次性定位元素。

---

## 2. ✂️ 切片索引 (Slicing)
切片允许我们选取一个范围内的元素，其语法是 `start:end`。

> [!quote] 重要特性
> 使用冒号 `:` 进行切片**不会减少**张量的维度。

> [!example] 代码示例分析
> ```python
> # 初始张量形状: (4, 3, 28, 28)
> 
> # 选取第 0 维中从开头到索引 2 (不含) 的所有元素 (前2张图片)
> a[:2].shape
> # 输出: torch.Size([2, 3, 28, 28])
> 
> # 选取前2张图片，且只取第1个颜色通道
> a[:2, :1, :, :].shape
> # 输出: torch.Size([2, 1, 28, 28])
> 
> # 选取前2张图片，且只取最后一个颜色通道
> # -1 表示倒数第一个元素
> a[:2, -1:, :, :].shape
> # 输出: torch.Size([2, 1, 28, 28])
> ```

> [!tip] 核心要点
> - 切片语法 `start:end` 保持维度数量不变。
> - 负数索引从后往前计数，非常方便。

---

## 3. 🚶‍♂️ 步长切片 (Slicing with Steps)
这是标准切片的扩展，语法为 `start:end:step`，允许我们跳跃式地选取元素，常用于数据降采样。

> [!example] 代码示例分析
> ```python
> # 初始张量形状: (4, 3, 28, 28)
> 
> # 对高和宽进行隔点采样，步长为 2
> a[:, :, 0:28:2, 0:28:2].shape
> # 输出: torch.Size([4, 3, 14, 14])
> 
> # 更简洁的写法，省略 start 和 end
> a[:, :, ::2, ::2].shape
> # 输出: torch.Size([4, 3, 14, 14])
> ```

> [!tip] 核心要点
> - `::step` 是一个强大的语法，用于对整个维度进行均匀采样。
> - 这是图像处理中实现“下采样”的常用高效方法。

---

## 4. ✨ 省略号索引 (Ellipsis `...`)
省略号 `...` 是一个便捷的语法糖，代表“任意多个 `:` 以填充空缺的维度”。

> [!question] ... 是什么?
> `...` 会自动扩展为所需数量的 `:`，以使索引表达式的维度完整。

> [!example] 代码示例分析
> ```python
> # 初始张量形状: (4, 3, 28, 28)
> 
> # a[...] 等价于 a[:, :, :, :]
> a[...].shape
> # 输出: torch.Size([4, 3, 28, 28])
> 
> # a[0, ...] 等价于 a[0, :, :, :]
> a[0, ...].shape
> # 输出: torch.Size([3, 28, 28])
> 
> # a[..., :2] 等价于 a[:, :, :, :2]
> # 这个用法非常普遍，用于操作最后几个维度
> a[..., :2].shape
> # 输出: torch.Size([4, 3, 28, 2])
> ```

> [!tip] 核心要点
> - `...` 可以让你专注于操作首/尾维度，代码更具可读性和扩展性，尤其是在处理不确定维数的张量时。

---

## 5. 🎯 使用 `index_select()` 按指定索引选取
当你需要选取一个维度上**不连续的**、**特定的**几个索引时，`index_select()` 函数非常有用。

> [!success] 函数原型
> `torch.index_select(tensor, dim, indices)`

> [!example] 代码示例分析
> ```python
> # 初始张量形状: (4, 3, 28, 28)
> 
> # 示例：在第 0 维(批量维)上，选取索引为 0 和 2 的元素
> indices = torch.tensor([0, 2])
> a.index_select(0, indices).shape
> # 输出: torch.Size([2, 3, 28, 28])
> 
> # 示例：在第 2 维(高度维)上，选取前 8 行
> indices = torch.arange(8)
> a.index_select(2, indices).shape
> # 输出: torch.Size([4, 3, 8, 28])
> ```

> [!tip] 核心要点
> - `index_select` 非常适合于需要根据一个索引列表来“采集”或“重排”数据的场景。
> - 和切片一样，它保持张量的维度数量不变。

---

## 6. 🎭 使用 `masked_select()` 按掩码选取
这种方法允许你根据一个布尔张量 (mask) 来选取元素，只有在掩码中对应位置为 `True` 的元素才会被选中。

> [!example] 代码示例分析
> ```python
> # 创建一个 3x4 的随机张量
> x = torch.randn(3, 4)
> 
> # 创建一个布尔掩码，条件是: 元素值 >= 0.5
> mask = x.ge(0.5) # ge = Greater or Equal
> 
> # 从 x 中选取所有在 mask 中为 True 的元素
> torch.masked_select(x, mask)
> # 输出: 一个包含所有 >= 0.5 的值的一维张量
> 
> # 查看输出形状
> torch.masked_select(x, mask).shape
> # 输出: torch.Size([N])，N 是 mask 中 True 的数量
> ```

> [!warning] 核心要点：输出为一维
> - `masked_select` 的输出**总是一个一维张量**，其长度等于掩码中 `True` 的数量。它不保留原始张量的形状。
> - 这是基于**值**的条件筛选，而不是基于**位置**的索引。

---

## 7. 📥 使用 `take()` 按扁平化索引选取
`take()` 函数将输入张量视为一个**一维数组**，然后根据你提供的索引来选取元素。

> [!bug] 注意：忽略维度结构
> `take()` 完全忽略张量的多维结构，只关心元素在内存中的**线性顺序**。如果不清楚底层数据布局，可能会导致意外结果。

> [!example] 代码示例分析
> ```python
> # 创建一个 2x3 的张量
> src = torch.tensor([[4, 3, 5], 
>                     [6, 7, 8]])
> 
> # 在 take() 眼中，src 被“拉平”(flatten) 为:
> # [4, 3, 5, 6, 7, 8]
> # 索引: 0, 1, 2, 3, 4, 5
> 
> # 从这个被拉平的视图中，取出索引为 0, 2, 和 5 的元素
> torch.take(src, torch.tensor([0, 2, 5]))
> # 输出: tensor([4, 5, 8])
> ```

---

## 📈 综述与对比

| 方法 | 主要用途 | 输出维度 | 示例 |
| :--- | :--- | :--- | :--- |
| **📌 基本索引** | 选取单个元素或降维切片 | 比输入低 | `a[0]`, `a[0,0]` |
| **✂️ 切片索引** | 选取连续或带步长的范围 | 与输入相同 | `a[:2]`, `a[:,::2]` |
| **✨ 省略号索引** | 简化高维张量切片 | 与输入相同 | `a[..., -1]` |
| **🎯 `index_select()`** | 按指定索引列表选取数据 | 与输入相同 | `a.index_select(0, torch.tensor([1,3]))` |
| **🎭 `masked_select()`** | 根据条件 (值) 筛选元素 | **一维向量** | `torch.masked_select(a, a > 0)` |
| **📥 `take()`** | 按扁平化后的索引选取元素 | 与索引形状相同 | `torch.take(a, torch.tensor([0,5]))` |