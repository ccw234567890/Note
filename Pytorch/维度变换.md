# PyTorch æ ¸å¿ƒå¼ é‡æ“ä½œå­¦ä¹ ç¬”è®°

## æ¦‚è§ˆï¼šå››ç§æ ¸å¿ƒæ“ä½œ

> [!abstract] è¯¾ç¨‹ç›®å½•
> - **View / reshape**: æ”¹å˜å¼ é‡çš„å½¢çŠ¶
> - **Squeeze / unsqueeze**: åŽ‹ç¼©æˆ–å¢žåŠ ç»´åº¦
> - **Transpose / t / permute**: äº¤æ¢ç»´åº¦
> - **Expand / repeat**: æ‰©å±•æˆ–é‡å¤å¼ é‡

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šå¼ é‡å½¢çŠ¶å˜æ¢

### ä¸»é¢˜ï¼šå¼ é‡å˜å½¢ `View` / `Reshape`

> [!note] åŠŸèƒ½è¯´æ˜Ž
> ä½¿ç”¨ `.view()` æˆ– `.reshape()` å¯ä»¥å¿«é€Ÿæ”¹å˜å¼ é‡çš„å½¢çŠ¶ï¼Œä½†ä¸ä¼šæ”¹å˜å…¶ä¸­å…ƒç´ çš„æ€»æ•°ã€‚

> [!example] ä»£ç ç¤ºä¾‹
> ```python
> # a çš„åŽŸå§‹å½¢çŠ¶: (4, 1, 28, 28)
> a = torch.rand(4, 1, 28, 28)
> 
> # å°†æ¯å¼  1x28x28 çš„å›¾åƒ"åŽ‹å¹³"æˆä¸€ä¸ª 784 ç»´çš„å‘é‡
> # a çš„æ–°å½¢çŠ¶: (4, 784)
> b = a.view(4, 28*28) 
> ```

> [!warning] æ³¨æ„ï¼šæ½œåœ¨çš„é€»è¾‘é—®é¢˜
> - **ä¸¢å¤±ç»´åº¦ä¿¡æ¯ (Lost dim information)**: å°† `(4, 1, 28, 28)` å˜å½¢ä¸º `(4, 784)` åŽï¼ŒåŽŸæœ‰çš„é€šé“ã€é«˜åº¦ã€å®½åº¦ç­‰ç»“æž„ä¿¡æ¯å°±ä¸¢å¤±äº†ã€‚
> - **é€»è¾‘é”™è¯¯ (Logic Bug)**: ä¾‹å­ä¸­ï¼Œ`b.view(4, 28, 28, 1)` è™½ç„¶å…ƒç´ æ•°é‡æ­£ç¡®ï¼Œä½†å…¶ç»´åº¦é¡ºåº `(4, 28, 28, 1)` å’ŒåŽŸå§‹çš„ `a` å¼ é‡ `(4, 1, 28, 28)` ä¸åŒï¼Œè¿™å¯èƒ½å¯¼è‡´åŽç»­è¿ç®—å‡ºé”™ã€‚

> [!danger] æ ¸å¿ƒé™åˆ¶ï¼šå…ƒç´ æ€»æ•°å¿…é¡»ä¸¥æ ¼åŒ¹é…
> `view()` æ“ä½œå¿…é¡»éµå®ˆ **å…ƒç´ æ€»æ•°ä¸å˜** çš„åŽŸåˆ™ã€‚
> ```python
> # åŽŸå§‹å¼ é‡ a çš„å…ƒç´ æ€»æ•°æ˜¯ 4 * 1 * 28 * 28 = 3136
> 
> # å°è¯• view æˆ 4 * 783 = 3132 ä¸ªå…ƒç´ ï¼Œä¼šç›´æŽ¥æŠ¥é”™
> a.view(4, 783) 
> # RuntimeError: shape '[4, 783]' is invalid for input of size 3136
> ```

### ä¸»é¢˜ï¼š`Squeeze` vs `Unsqueeze` (æŒ¤åŽ‹ä¸Žè§£åŽ‹)

> [!quote] å½¢è±¡æ¯”å–»
> - ðŸ‹ **Squeeze (æŒ¤åŽ‹)**: åƒæŒ¤æŸ æª¬ä¸€æ ·ï¼Œ**ç§»é™¤** å¼ é‡ä¸­å¤§å°ä¸º 1 çš„ç»´åº¦ã€‚
> - ðŸŽ **Unsqueeze (è§£åŽ‹)**: åƒæ‰“å¼€ç¤¼ç‰©ç›’ä¸€æ ·ï¼Œ**å¢žåŠ ** ä¸€ä¸ªå¤§å°ä¸º 1 çš„æ–°ç»´åº¦ã€‚

### æ“ä½œï¼š`unsqueeze()` è¯¦è§£ (å¢žåŠ ç»´åº¦)

> [!tip] åŠŸèƒ½ä¸Žç´¢å¼•
> - **åŠŸèƒ½**: `unsqueeze(dim)` åœ¨æŒ‡å®šçš„ä½ç½® `dim` å¢žåŠ ä¸€ä¸ªå¤§å°ä¸º 1 çš„ç»´åº¦ã€‚
> - **ç´¢å¼•**: å¯¹äºŽä¸€ä¸ª N ç»´å¼ é‡ï¼Œ`dim` çš„æœ‰æ•ˆèŒƒå›´æ˜¯ `[-N-1, N]`ã€‚æ­£ç´¢å¼•ä»Žå‰æ•°ï¼Œè´Ÿç´¢å¼•ä»ŽåŽæ•°ã€‚

> [!example] ä»£ç ç¤ºä¾‹
> ```python
> # a çš„å½¢çŠ¶: (4, 1, 28, 28)
> 
> # åœ¨æœ€å‰é¢ (ç´¢å¼•0) å¢žåŠ ç»´åº¦
> a.unsqueeze(0).shape # -> torch.Size([1, 4, 1, 28, 28])
> 
> # åœ¨æœ€åŽé¢ (ç´¢å¼•-1) å¢žåŠ ç»´åº¦
> a.unsqueeze(-1).shape # -> torch.Size([4, 1, 28, 28, 1])
> 
> # é“¾å¼æ“ä½œï¼š(32) -> (1, 32, 1, 1)
> b = torch.rand(32)
> b.unsqueeze(1).unsqueeze(2).unsqueeze(0).shape # -> torch.Size([1, 32, 1, 1])
> ```

### æ“ä½œï¼š`squeeze()` è¯¦è§£ (ç§»é™¤ç»´åº¦)

> [!info] ä¸¤ç§ç”¨æ³•
> 1. `squeeze()`: ä¸å¸¦å‚æ•°ï¼Œç§»é™¤ **æ‰€æœ‰** å¤§å°ä¸º 1 çš„ç»´åº¦ã€‚
> 2. `squeeze(dim)`: å¸¦å‚æ•°ï¼Œåªåœ¨ **æŒ‡å®šä½ç½® `dim`** çš„ç»´åº¦å¤§å°ä¸º 1 æ—¶æ‰ç§»é™¤å®ƒã€‚

> [!example] ä»£ç ç¤ºä¾‹
> ```python
> # b çš„å½¢çŠ¶: (1, 32, 1, 1)
> b = torch.rand(1, 32, 1, 1)
> 
> # ç§»é™¤æ‰€æœ‰å¤§å°ä¸º1çš„ç»´åº¦
> b.squeeze().shape # -> torch.Size([32])
> 
> # åªç§»é™¤ç´¢å¼•0çš„ç»´åº¦
> b.squeeze(0).shape # -> torch.Size([32, 1, 1])
> 
> # å°è¯•ç§»é™¤ç´¢å¼•1çš„ç»´åº¦ï¼ˆå¤§å°ä¸º32ï¼‰ï¼Œå½¢çŠ¶ä¸å˜
> b.squeeze(1).shape # -> torch.Size([1, 32, 1, 1])
> ```

---
## ç¬¬äºŒéƒ¨åˆ†ï¼šå¼ é‡æ‰©å±•ä¸Žç»´åº¦äº¤æ¢

### ä¸»é¢˜ï¼š`Expand` vs `Repeat` çš„æ ¸å¿ƒåŒºåˆ«

> [!summary] ä¸€å¥è¯æ€»ç»“
> `expand` æ˜¯é«˜æ•ˆçš„â€œè§†å›¾â€å¹¿æ’­ï¼Œä¸å¤åˆ¶æ•°æ®ï¼›`repeat` æ˜¯â€œç‰©ç†â€ä¸Šçš„å¤åˆ¶ï¼Œä¼šåˆ›å»ºæ–°çš„æ•°æ®å‰¯æœ¬ã€‚

> [!note] `expand()` - å¹¿æ’­æœºåˆ¶
> - **åŽŸç†**: åŸºäºŽå¹¿æ’­ (Broadcasting)ï¼Œä¸å®žé™…å¤åˆ¶æ•°æ®ï¼Œéžå¸¸èŠ‚çœå†…å­˜ã€‚
> - **è§„åˆ™**: åªèƒ½æ‰©å±•å¤§å°ä¸º 1 çš„ç»´åº¦ã€‚
> - **å‚æ•°**: ç›®æ ‡å½¢çŠ¶ã€‚ä½¿ç”¨ `-1` è¡¨ç¤ºè¯¥ç»´åº¦å¤§å°ä¸å˜ã€‚

> [!caution] `repeat()` - å†…å­˜æ‹·è´
> - **åŽŸç†**: åœ¨å†…å­˜ä¸­ **çœŸæ­£åœ°å¤åˆ¶æ•°æ®** æ¥å¡«å……ï¼Œä¼šæ¶ˆè€—æ›´å¤šå†…å­˜ã€‚
> - **è§„åˆ™**: å°†å¼ é‡æ²¿å„ä¸ªç»´åº¦ **é‡å¤æŒ‡å®šçš„æ¬¡æ•°**ã€‚
> - **å‚æ•°**: æ¯ä¸ªç»´åº¦çš„ **é‡å¤å€æ•°**ã€‚

### æ“ä½œï¼š`expand()` å’Œ `repeat()` ç¤ºä¾‹

> [!example] `expand()` ä»£ç ç¤ºä¾‹
> ```python
> # b çš„å½¢çŠ¶: (1, 32, 1, 1)
> b = torch.rand(1, 32, 1, 1)
> 
> # æ‰©å±•å¤§å°ä¸º1çš„ç»´åº¦ï¼Œå¤§å°ä¸º32çš„ç»´åº¦ä¿æŒä¸å˜
> b.expand(4, 32, 14, 14).shape # -> torch.Size([4, 32, 14, 14])
> ```

> [!example] `repeat()` ä»£ç ç¤ºä¾‹
> ```python
> # b çš„å½¢çŠ¶: (1, 32, 1, 1)
> b = torch.rand(1, 32, 1, 1)
> 
> # å°†ç¬¬0ç»´é‡å¤4æ¬¡ï¼Œç¬¬1ç»´é‡å¤32æ¬¡
> # æ–°å½¢çŠ¶: (1*4, 32*32, 1*1, 1*1)
> b.repeat(4, 32, 1, 1).shape # -> torch.Size([4, 1024, 1, 1])
> ```

### ä¸»é¢˜ï¼šç»´åº¦äº¤æ¢ `transpose` & `permute`

> [!note] åŠŸèƒ½å¯¹æ¯”
> - **`.t()`**: `transpose(0, 1)` çš„ç®€å†™ï¼Œ**ä»…é€‚ç”¨äºŽ2Då¼ é‡**ã€‚
> - **`transpose(dimA, dimB)`**: äº¤æ¢ **ä»»æ„ä¸¤ä¸ª** æŒ‡å®šçš„ç»´åº¦ã€‚
> - **`permute(dims)`**: æœ€å¼ºå¤§çš„æ–¹æ³•ï¼Œå¯ä»¥ **ä¸€æ¬¡æ€§é‡æŽ’æ‰€æœ‰** ç»´åº¦ã€‚

> [!example] ä»£ç ç¤ºä¾‹
> ```python
> # b çš„å½¢çŠ¶: (4, 3, 28, 32)
> b = torch.rand(4, 3, 28, 32)
> 
> # äº¤æ¢ç´¢å¼• 1 å’Œ 3 çš„ç»´åº¦
> b.transpose(1, 3).shape # -> torch.Size([4, 32, 28, 3])
> 
> # å°†ç»´åº¦ (0,1,2,3) é‡æŽ’ä¸º (0,2,3,1)
> b.permute(0, 2, 3, 1).shape # -> torch.Size([4, 28, 32, 3])
> ```

### æ ¸å¿ƒé‡ç‚¹ï¼šå†…å­˜è¿žç»­æ€§ (`contiguous`)

> [!bug] é—®é¢˜æ ¹æºï¼š`transpose` / `permute` å¯¼è‡´å†…å­˜ä¸è¿žç»­
> `transpose` æˆ– `permute` æ“ä½œé€šå¸¸åªä¿®æ”¹å¼ é‡çš„å…ƒæ•°æ®ï¼ˆæ­¥é•¿ strideï¼‰ï¼Œè€Œä¸ä¼šç§»åŠ¨å†…å­˜ä¸­çš„æ•°æ®ã€‚è¿™ä¼šå¯¼è‡´å¼ é‡åœ¨å†…å­˜ä¸­çš„å¸ƒå±€å˜å¾— **ä¸è¿žç»­ (non-contiguous)**ã€‚
> è€Œ `.view()` ç­‰æ“ä½œè¦æ±‚å¼ é‡å¿…é¡»æ˜¯å†…å­˜è¿žç»­çš„ï¼Œå› æ­¤ç›´æŽ¥è°ƒç”¨ä¼šæŠ¥é”™ã€‚

> [!danger] é”™è¯¯æ¼”ç¤º
> ```python
> a = torch.rand(4, 3, 32, 32)
> 
> # transpose ä½¿ a å†…å­˜ä¸è¿žç»­ï¼Œå†è°ƒç”¨ view ä¼šå¤±è´¥
> a.transpose(1, 3).view(4, 3*32*32) 
> # RuntimeError: view size is not compatible with input tensor's size and stride...
> ```

> [!success] æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆ
> åœ¨è¿›è¡Œ `view` æ“ä½œå‰ï¼Œè°ƒç”¨ **`.contiguous()`** æ–¹æ³•ï¼Œå®ƒä¼šè¿”å›žä¸€ä¸ªå†…å­˜è¿žç»­çš„æ–°å¼ é‡ã€‚
> ```python
> a = torch.rand(4, 3, 32, 32)
> 
> # è°ƒç”¨ .contiguous() è§£å†³é—®é¢˜
> a.transpose(1, 3).contiguous().view(4, 3*32*32) # -> OK
> ```

---
# æ·±å…¥ç†è§£PyTorchå†…å­˜å¸ƒå±€ï¼š`contiguous`, `transpose`ä¸Ž`view`çš„æ ¸å¿ƒ

> [!abstract] å†…å®¹æè¦
> è¿™ç¯‡ç¬”è®°å°†æ·±å…¥æŽ¢è®¨ä¸€ä¸ªåœ¨ PyTorch ä¸­éžå¸¸å¸¸è§ä½†åˆå®¹æ˜“æ··æ·†çš„é—®é¢˜ï¼šä¸ºä»€ä¹ˆ `transpose()` ä¹‹åŽè°ƒç”¨ `.view()` ä¼šæŠ¥é”™ï¼Ÿæˆ‘ä»¬å°†ä»Žæœ€åŸºæœ¬çš„å†…å­˜æ¦‚å¿µå‡ºå‘ï¼Œå±‚å±‚é€’è¿›ï¼Œå½»åº•æžæ‡‚å…¶èƒŒåŽçš„å·¥ä½œåŽŸç†ã€‚
> 1.  **åŸºæœ¬æ¦‚å¿µ**ï¼šå†…å­˜ã€å…ƒæ•°æ® (Metadata)
> 2.  **æ ¸å¿ƒæœºåˆ¶**ï¼šæ­¥é•¿ (Stride) ä¸Ž `transpose` çš„å·¥ä½œåŽŸç†
> 3.  **é—®é¢˜æ ¹æº**ï¼šä¸ºä»€ä¹ˆ `.view()` ä¼šå¤±è´¥ä»¥åŠå¦‚ä½•ç”¨ `.contiguous()` è§£å†³

---

## ç¬¬1éƒ¨åˆ†ï¼šåŸºæœ¬æ¦‚å¿µï¼šå†…å­˜ä¸Žå…ƒæ•°æ®

> [!note] ðŸ§  ä»€ä¹ˆæ˜¯å†…å­˜ (Memory)ï¼Ÿ
> ä½ å¯ä»¥æŠŠè®¡ç®—æœºçš„å†…å­˜ï¼ˆRAMï¼‰æƒ³è±¡æˆä¸€æ¡éžå¸¸é•¿çš„ã€ä¸€ç»´çš„è¡—é“ã€‚
> -   è¡—é“ä¸Šçš„æ¯ä¸ªæˆ¿å­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„é—¨ç‰Œå·ï¼Œè¿™å°±æ˜¯ **å†…å­˜åœ°å€**ã€‚
> -   æ¯ä¸ªæˆ¿å­é‡Œå¯ä»¥å­˜æ”¾ä¸œè¥¿ï¼Œè¿™å°±æ˜¯ **æ•°æ®**ã€‚
>
> 
>æ— è®ºä½ çš„æ•°æ®ç»“æž„ï¼ˆå¦‚äºŒç»´çŸ©é˜µï¼‰å¤šä¹ˆå¤æ‚ï¼Œæœ€ç»ˆéƒ½å¿…é¡»è¢«â€œåŽ‹å¹³â€æˆä¸€ç»´åºåˆ—ï¼Œå­˜æ”¾åœ¨è¿™æ¡è¡—é“ä¸Šã€‚

> [!info] ðŸ“ ä»€ä¹ˆæ˜¯å¼ é‡ (Tensor) ä¸Žå…ƒæ•°æ® (Metadata)ï¼Ÿ
> å½“ä½ åˆ›å»ºä¸€ä¸ªå¼ é‡æ—¶ï¼ŒPyTorch ä¼šåšä¸¤ä»¶äº‹ï¼š
> 1.  **å­˜å‚¨æ•°æ®**ï¼šåœ¨å†…å­˜â€œè¡—é“â€ä¸Šç”³è¯·ä¸€å—è¿žç»­çš„ç©ºé—´ï¼ŒæŠŠå¼ é‡çš„æ‰€æœ‰å…ƒç´ ï¼ˆå¦‚ `[1, 2, 3, 4, 5, 6]`ï¼‰æŒ‰é¡ºåºæ”¾è¿›åŽ»ã€‚
> 2.  **åˆ›å»ºå…ƒæ•°æ®**ï¼šåˆ›å»ºä¸€ä»½â€œè¯´æ˜Žä¹¦â€æ¥æè¿°è¿™å—æ•°æ®ã€‚è¿™ä»½è¯´æ˜Žä¹¦å°±æ˜¯**å…ƒæ•°æ® (Metadata)**ï¼Œå³â€œå…³äºŽæ•°æ®çš„æ•°æ®â€ã€‚
> 
> å…ƒæ•°æ®ä¸»è¦åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š
> -   **Data Pointer**: æŒ‡å‘æ•°æ®åœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€ï¼ˆç¬¬ä¸€ä¸ªå…ƒç´ çš„â€œé—¨ç‰Œå·â€ï¼‰ã€‚
> -   **Shape (å½¢çŠ¶)**: æè¿°å¼ é‡çš„é€»è¾‘ç»´åº¦ï¼Œä¾‹å¦‚ `(2, 3)`ã€‚
> -   **Stride (æ­¥é•¿)**: **ç†è§£æœ¬é—®é¢˜çš„å…³é”®**ï¼Œå®šä¹‰äº†åœ¨å†…å­˜ä¸­å¦‚ä½•ç§»åŠ¨æ¥å¯»æ‰¾ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚
> -   **Dtype (æ•°æ®ç±»åž‹)**: ä¾‹å¦‚ `torch.float32`ã€‚

---

## ç¬¬2éƒ¨åˆ†ï¼šæ ¸å¿ƒæœºåˆ¶ï¼šæ­¥é•¿(Stride)ä¸Ž`transpose`

> [!tip] ðŸ‘£ æ·±å…¥ç†è§£æ­¥é•¿ (Stride)
> **å®šä¹‰**ï¼šåœ¨æŸä¸ªç»´åº¦ä¸Šï¼Œä»Žä¸€ä¸ªå…ƒç´ ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œéœ€è¦åœ¨ç‰©ç†å†…å­˜ä¸­â€œè·³â€è¿‡å¤šå°‘ä¸ªä½ç½®ã€‚
> 
> **ç¤ºä¾‹**ï¼šå¯¹äºŽå¼ é‡ `a = torch.tensor([[1, 2, 3], [4, 5, 6]])`ï¼Œå…¶ç‰©ç†å†…å­˜ä¸º `[1, 2, 3, 4, 5, 6]`ã€‚
> -   **ç»´åº¦0 (è¡Œ)**: ä»Ž `a[0,0]`(1) åˆ° `a[1,0]`(4)ï¼Œéœ€è¦è·³ **3** ä¸ªä½ç½®ã€‚æ‰€ä»¥ç»´åº¦0çš„æ­¥é•¿æ˜¯ **3**ã€‚
> -   **ç»´åº¦1 (åˆ—)**: ä»Ž `a[0,0]`(1) åˆ° `a[0,1]`(2)ï¼Œéœ€è¦è·³ **1** ä¸ªä½ç½®ã€‚æ‰€ä»¥ç»´åº¦1çš„æ­¥é•¿æ˜¯ **1**ã€‚
> 
> å› æ­¤ï¼Œå¼ é‡ `a` çš„æ­¥é•¿æ˜¯ `(3, 1)`ã€‚
> å½“ä¸€ä¸ªå¼ é‡çš„ç‰©ç†å†…å­˜å¸ƒå±€å’Œå…¶æ­¥é•¿æ»¡è¶³è¿™ç§æ ‡å‡†å…³ç³»æ—¶ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º **å†…å­˜è¿žç»­çš„ (Contiguous)**ã€‚

> [!example] `transpose` æ“ä½œçš„çœŸç›¸
> å½“æˆ‘ä»¬æ‰§è¡Œ `b = a.transpose(0, 1)` æ—¶ï¼Œ**ç‰©ç†å†…å­˜ä¸­çš„æ•°æ® `[1, 2, 3, 4, 5, 6]` æ ¹æœ¬æ²¡æœ‰åŠ¨ï¼**
> `transpose` ä»…ä»…æ˜¯äº¤æ¢äº†å…ƒæ•°æ®ä¸­çš„ `shape` å’Œ `stride`ï¼š
> 
> | å±žæ€§ | åŽŸå§‹ `a` | `transpose` åŽçš„ `b` |
> | :--- | :--- | :--- |
> | **Shape** | `(2, 3)` | `(3, 2)` |
> | **Stride** | `(3, 1)` | `(1, 3)` |
> 
> `b` çš„é€»è¾‘è§†å›¾æ˜¯ `[[1, 4], [2, 5], [3, 6]]`ï¼Œå®ƒçš„æ–°æ­¥é•¿ `(1, 3)` å®Œç¾Žåœ°æè¿°äº†å¦‚ä½•åœ¨**æœªæ”¹å˜çš„æ—§å†…å­˜**ä¸Šæ‰¾åˆ°è¿™äº›å…ƒç´ ã€‚

> [!warning] è­¦å‘Šï¼šå†…å­˜å˜å¾—ä¸è¿žç»­ (Non-Contiguous)
> `transpose` ä¹‹åŽï¼Œå¼ é‡ `b` è™½ç„¶é€»è¾‘ä¸Šæœ‰æ•ˆï¼Œä½†å…¶å†…å­˜å¸ƒå±€å·²ç»ä¸å†æ˜¯æ ‡å‡†çš„â€œè¿žç»­â€çŠ¶æ€ã€‚
> -   ä¸€ä¸ªæ–°åˆ›å»ºçš„ã€è¿žç»­çš„ `(3, 2)` å¼ é‡ï¼Œå…¶æ­¥é•¿åº”è¯¥æ˜¯ `(2, 1)`ã€‚
> -   è€Œ `b` çš„æ­¥é•¿æ˜¯ `(1, 3)`ã€‚
> 
> ä¸¤è€…ä¸åŒ¹é…ï¼Œæ‰€ä»¥ `b` æ˜¯ **ä¸è¿žç»­çš„**ã€‚

---

## ç¬¬3éƒ¨åˆ†ï¼šé—®é¢˜æ ¹æºä¸Žè§£å†³æ–¹æ¡ˆ

> [!question] â“ ä¸ºä»€ä¹ˆ `.view()` ä¼šåœ¨è¿™ç§æƒ…å†µä¸‹å¤±è´¥ï¼Ÿ
> `.view()` æ˜¯ä¸€ä¸ªçº¯å…ƒæ•°æ®æ“ä½œï¼Œä¸ºäº†ä¿è¯æžé«˜çš„æ‰§è¡Œæ•ˆçŽ‡ï¼Œå®ƒä¹Ÿæœ‰ä¸€ä¸ªå‰æå‡è®¾ï¼š**è¢«æ“ä½œçš„å¼ é‡å¿…é¡»æ˜¯å†…å­˜è¿žç»­çš„**ã€‚
> 
> å½“ä½ å¯¹ä¸è¿žç»­çš„å¼ é‡ `b` è°ƒç”¨ `.view()` æ—¶ï¼Œ`.view()` ä¼šå‘çŽ°å¼ é‡çš„ç‰©ç†å†…å­˜é¡ºåº (`1, 2, 3, 4, 5, 6`) ä¸Žå…¶é€»è¾‘é¡ºåº (`1, 4, 2, 5, 3, 6`) ä¸ä¸€è‡´ã€‚å¦‚æžœå¼ºè¡Œæ“ä½œï¼Œä¼šäº§ç”Ÿé”™è¯¯çš„æ•°æ®ã€‚

> [!danger] é”™è¯¯æ¼”ç¤ºä¸Žæ ¹æº
> ä¸ºäº†é˜²æ­¢æ•°æ®è¢«ç ´åï¼ŒPyTorch åœ¨æ‰§è¡Œ `.view()` å‰ä¼šæ£€æŸ¥å†…å­˜æ˜¯å¦è¿žç»­ã€‚å½“æ£€æŸ¥åˆ°ä¸è¿žç»­æ—¶ï¼Œå®ƒä¼šç«‹å³æŠ¥é”™ã€‚
> ```python
> # a æ˜¯è¿žç»­çš„
> a = torch.rand(4, 3, 32, 32)
> 
> # b = a.transpose(1, 3) ä¹‹åŽï¼Œb å˜å¾—ä¸è¿žç»­
> b = a.transpose(1, 3)
> 
> # å¯¹ä¸è¿žç»­çš„ b è°ƒç”¨ view ä¼šå¤±è´¥ï¼
> b.view(4, 3*32*32) 
> # RuntimeError: view size is not compatible with input tensor's size and stride...
> ```

> [!success] âœ… è§£å†³æ–¹æ¡ˆï¼š`.contiguous()`
> `.contiguous()` çš„ä½œç”¨å°±æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å®ƒä¼šï¼š
> 1.  **å¼€è¾Ÿä¸€å—å…¨æ–°çš„å†…å­˜ç©ºé—´**ã€‚
> 2.  **æŒ‰ç…§åŽŸå¼ é‡çš„é€»è¾‘é¡ºåºï¼Œå°†æ•°æ®ä¸€ä¸ªä¸ªåœ°å¤åˆ¶åˆ°æ–°å†…å­˜ä¸­**ã€‚
> 3.  **è¿”å›žä¸€ä¸ªå†…å­˜è¿žç»­çš„ã€å…¨æ–°çš„å¼ é‡å‰¯æœ¬**ã€‚
> 
> è¿™ä¸ªæ–°å‰¯æœ¬å°±å¯ä»¥å®‰å…¨åœ°äº¤ç»™ `.view()` ä½¿ç”¨äº†ã€‚
> ```python
> # åœ¨è°ƒç”¨ view ä¹‹å‰ï¼Œå…ˆè°ƒç”¨ .contiguous()
> # contiguous() ä¼šè¿”å›žä¸€ä¸ªå†…å­˜è¿žç»­çš„æ–°å¼ é‡
> contiguous_b = b.contiguous()
> 
> # çŽ°åœ¨å¯ä»¥å®‰å…¨åœ° view äº†
> contiguous_b.view(4, 3*32*32) # OK!
> 
> # é“¾å¼è°ƒç”¨
> a.transpose(1, 3).contiguous().view(4, 3*32*32) # åŒæ · OK!
> ```