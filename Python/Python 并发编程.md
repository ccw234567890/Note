# ğŸ­ Python å¹¶å‘ç¼–ç¨‹ï¼šè¿›ç¨‹ä¸çº¿ç¨‹

> [!TIP] æ ¸å¿ƒæ¯”å–»ï¼šå·¥å‚ä¸å·¥äºº
> - **è¿›ç¨‹ (Process)** å°±åƒä¸€ä¸ª**å·¥å‚** ğŸ­ã€‚å®ƒæ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„èµ„æºï¼ˆåœŸåœ°ã€ç”µåŠ›ã€åŸææ–™ï¼‰ã€‚å»ºä¸€ä¸ªæ–°å·¥å‚å¼€é”€å¾ˆå¤§ã€‚
> - **çº¿ç¨‹ (Thread)** å°±åƒå·¥å‚é‡Œçš„ä¸€å**å·¥äºº** ğŸ‘·ã€‚å¤šä¸ªå·¥äººåœ¨åŒä¸€ä¸ªå·¥å‚é‡Œå…±äº«èµ„æºï¼ŒååŒå·¥ä½œã€‚é›‡ä¸€ä¸ªæ–°å·¥äººå¼€é”€å¾ˆå°ã€‚
> - **ç¨‹åº (Program)** å°±åƒå·¥å‚çš„**è®¾è®¡è“å›¾** ğŸ“œã€‚å®ƒæœ¬èº«æ˜¯é™æ€çš„ï¼Œåªæœ‰æŒ‰ç…§è“å›¾å¼€åŠå·¥å‚ï¼ˆè¿è¡Œç¨‹åºï¼‰ï¼Œæ‰æœ‰äº†è¿›ç¨‹ã€‚

---

## <span style="color:#3498db;">ç¬¬ä¸€éƒ¨åˆ†ï¼šè¿›ç¨‹ (Process) - ç‹¬ç«‹çš„è½¦é—´</span>

### <span style="color:#5dade2;">â‘  ç¨‹åºä¸è¿›ç¨‹</span>
- **ç¨‹åº (Program)**: å­˜å‚¨åœ¨ç£ç›˜ä¸Šçš„**é™æ€æ–‡ä»¶**ï¼Œå¦‚ `.py` æ–‡ä»¶ã€`.exe` æ–‡ä»¶ã€‚
- **è¿›ç¨‹ (Process)**: ç¨‹åºçš„ä¸€æ¬¡**åŠ¨æ€æ‰§è¡Œè¿‡ç¨‹**ã€‚æ“ä½œç³»ç»Ÿä¼šä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…ç‹¬ç«‹çš„å†…å­˜ç©ºé—´å’Œç³»ç»Ÿèµ„æºã€‚è¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿè¿›è¡Œ**èµ„æºåˆ†é…**çš„åŸºæœ¬å•ä½ã€‚

### <span style="color:#5dade2;">â‘¡ åˆ›å»ºè¿›ç¨‹ (`multiprocessing` æ¨¡å—)</span>
Python é€šè¿‡ `multiprocessing` æ¨¡å—æ”¯æŒå¤šè¿›ç¨‹ç¼–ç¨‹ã€‚

#### <span style="color:#a5b1c2;">å®æˆ˜ä»£ç ï¼šåˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ªå­è¿›ç¨‹</span>
```python
import multiprocessing
import os
import time

# è¿™æ˜¯å­è¿›ç¨‹è¦æ‰§è¡Œçš„ä»»åŠ¡
def worker_task(name):
    print(f"å­è¿›ç¨‹å¯åŠ¨ï¼ŒID: {os.getpid()}, å‚æ•°: {name}")
    time.sleep(2) # æ¨¡æ‹Ÿä»»åŠ¡è€—æ—¶
    print(f"å­è¿›ç¨‹ {os.getpid()} ç»“æŸã€‚")

# __name__ == '__main__' æ˜¯å¯åŠ¨å¤šè¿›ç¨‹çš„å¿…è¦ä¿æŠ¤
if __name__ == '__main__':
    print(f"ä¸»è¿›ç¨‹å¯åŠ¨ï¼ŒID: {os.getpid()}")
    
    # 1. åˆ›å»ºä¸€ä¸ª Process å¯¹è±¡
    # target=worker_task æŒ‡å®šäº†å­è¿›ç¨‹è¦æ‰§è¡Œçš„å‡½æ•°
    # args=('ä»»åŠ¡A',) æ˜¯ä¼ é€’ç»™å‡½æ•°çš„å‚æ•°ï¼Œæ³¨æ„æ˜¯å…ƒç»„å½¢å¼
    p = multiprocessing.Process(target=worker_task, args=('ä»»åŠ¡A',))
    
    # 2. å¯åŠ¨å­è¿›ç¨‹
    p.start()
    
    print("ä¸»è¿›ç¨‹ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡...")
    
    # 3. ç­‰å¾…å­è¿›ç¨‹æ‰§è¡Œç»“æŸ
    # ä¸»è¿›ç¨‹ä¼šåœ¨è¿™é‡Œé˜»å¡ï¼Œç›´åˆ°å­è¿›ç¨‹ p å®Œæˆä»»åŠ¡
    p.join()
    
    print("ä¸»è¿›ç¨‹ç»“æŸã€‚")
```

### <span style="color:#5dade2;">â‘¢ è¿›ç¨‹é—´é€šä¿¡ (IPC - Inter-Process Communication)</span>
å› ä¸ºè¿›ç¨‹é—´çš„å†…å­˜æ˜¯éš”ç¦»çš„ï¼Œæ‰€ä»¥éœ€è¦å€ŸåŠ©ç‰¹æ®Šçš„å·¥å…·æ¥é€šä¿¡ã€‚`multiprocessing.Queue` æ˜¯æœ€å¸¸ç”¨çš„å·¥å…·ä¹‹ä¸€ã€‚

#### <span style="color:#a5b1c2;">å®æˆ˜ä»£ç ï¼šä½¿ç”¨ `Queue` åœ¨ä¸¤ä¸ªè¿›ç¨‹é—´ä¼ é€’æ•°æ®</span>
```python
import multiprocessing
import time

# å†™æ•°æ®è¿›ç¨‹
def writer(q):
    print(f"Writer è¿›ç¨‹å¯åŠ¨...")
    for i in ['A', 'B', 'C']:
        print(f"å‘é˜Ÿåˆ—ä¸­æ”¾å…¥: {i}")
        q.put(i) # å°†æ•°æ®æ”¾å…¥é˜Ÿåˆ—
        time.sleep(1)
    print(f"Writer è¿›ç¨‹ç»“æŸã€‚")

# è¯»æ•°æ®è¿›ç¨‹
def reader(q):
    print(f"Reader è¿›ç¨‹å¯åŠ¨...")
    while True:
        try:
            # ä»é˜Ÿåˆ—ä¸­è·å–æ•°æ®ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œä¼šé˜»å¡ç­‰å¾…
            value = q.get(timeout=5) # è®¾ç½®5ç§’è¶…æ—¶
            print(f"ä»é˜Ÿåˆ—ä¸­è¯»åˆ°: {value}")
        except:
            # é˜Ÿåˆ—ä¸ºç©ºä¸”è¶…æ—¶ï¼Œé€€å‡ºå¾ªç¯
            print("é˜Ÿåˆ—å·²ç©ºï¼ŒReader è¿›ç¨‹ç»“æŸã€‚")
            break

if __name__ == '__main__':
    # 1. åˆ›å»ºä¸€ä¸ªè¿›ç¨‹å®‰å…¨çš„é˜Ÿåˆ—
    q = multiprocessing.Queue()
    
    # 2. åˆ›å»ºè¯»å†™ä¸¤ä¸ªè¿›ç¨‹
    pw = multiprocessing.Process(target=writer, args=(q,))
    pr = multiprocessing.Process(target=reader, args=(q,))
    
    # 3. å¯åŠ¨è¿›ç¨‹
    pw.start()
    pr.start()
    
    # 4. ç­‰å¾…è¿›ç¨‹ç»“æŸ
    pw.join()
    pr.join()
```

---

## <span style="color:#e67e22;">ç¬¬äºŒéƒ¨åˆ†ï¼šçº¿ç¨‹ (Thread) - åä½œçš„å·¥äºº</span>

### <span style="color:#f1c40f;">â‘£ è¿›ç¨‹ vs. çº¿ç¨‹</span>
| ç‰¹æ€§ | <span style="color:#3498db;">è¿›ç¨‹ (Process)</span> | <span style="color:#e67e22;">çº¿ç¨‹ (Thread)</span> |
| :--- | :--- | :--- |
| **å®šä¹‰** | **èµ„æºåˆ†é…**çš„åŸºæœ¬å•ä½ | **CPUè°ƒåº¦**çš„åŸºæœ¬å•ä½ |
| **å†…å­˜ç©ºé—´** | âœ… **ç‹¬ç«‹**ï¼Œäº’ä¸å¹²æ‰°ï¼Œå®‰å…¨æ€§é«˜ | âŒ **å…±äº«**ï¼Œæ•°æ®å…±äº«æ–¹ä¾¿ï¼Œä½†éœ€å¤„ç†åŒæ­¥é—®é¢˜ |
| **åˆ›å»ºå¼€é”€** | **å¤§**ï¼Œæ…¢ | **å°**ï¼Œå¿« |
| **é€šä¿¡** | å¤æ‚ï¼Œéœ€è¦ IPC (å¦‚ Queue) | ç®€å•ï¼Œç›´æ¥è¯»å†™å…±äº«å˜é‡ (ä½†éœ€åŠ é”) |
| **GIL å½±å“** | ä¸å— GIL å½±å“ï¼Œå¯å®ç°çœŸæ­£çš„**å¹¶è¡Œè®¡ç®—** (åˆ©ç”¨å¤šæ ¸) | å— GIL å½±å“ï¼ŒåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œ Python å­—èŠ‚ç  (é€‚ç”¨äº I/O å¯†é›†å‹ä»»åŠ¡) |

> [!WARNING] **GIL (å…¨å±€è§£é‡Šå™¨é”)**
> è¿™æ˜¯ CPython è§£é‡Šå™¨çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå®ƒä¿è¯åœ¨ä»»ä½•æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œ Python å­—èŠ‚ç ã€‚å› æ­¤ï¼ŒPython çš„å¤šçº¿ç¨‹å¯¹äº**è®¡ç®—å¯†é›†å‹**ä»»åŠ¡ï¼ˆå¦‚å¤§è§„æ¨¡æ•°å­¦è¿ç®—ï¼‰æå‡ä¸å¤§ï¼Œä½†å¯¹äº**I/Oå¯†é›†å‹**ä»»åŠ¡ï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶è¯»å†™ï¼‰æ•ˆæœæ˜¾è‘—ï¼Œå› ä¸ºå®ƒå¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾… I/O æ—¶ï¼Œåˆ‡æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚

### <span style="color:#f1c40f;">â‘¤ åˆ›å»ºçº¿ç¨‹ (`threading` æ¨¡å—)</span>

#### <span style="color:#a5b1c2;">å®æˆ˜ä»£ç ï¼šåˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ªå­çº¿ç¨‹</span>
```python
import threading
import time

def thread_task(name, duration):
    print(f"çº¿ç¨‹ {name} å¯åŠ¨...")
    time.sleep(duration)
    print(f"çº¿ç¨‹ {name} ç»“æŸã€‚")

print("ä¸»çº¿ç¨‹å¯åŠ¨...")

# 1. åˆ›å»ºçº¿ç¨‹å¯¹è±¡
t1 = threading.Thread(target=thread_task, args=("éŸ³ä¹æ’­æ”¾", 3))
t2 = threading.Thread(target=thread_task, args=("æ–‡ä»¶ä¸‹è½½", 2))

# 2. å¯åŠ¨çº¿ç¨‹
t1.start()
t2.start()

print("ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œ...")

# 3. ç­‰å¾…å­çº¿ç¨‹ç»“æŸ
t1.join()
t2.join()

print("æ‰€æœ‰å­çº¿ç¨‹å·²ç»“æŸï¼Œä¸»çº¿ç¨‹ç»“æŸã€‚")
```

### <span style="color:#f1c40f;">â‘¥ çº¿ç¨‹é—´é€šä¿¡ä¸åŒæ­¥</span>
çº¿ç¨‹å…±äº«å†…å­˜ï¼Œé€šä¿¡æ–¹ä¾¿ï¼Œä½†ä¹Ÿå¸¦æ¥äº†**æ•°æ®ç«äº‰ (Race Condition)** çš„é£é™©ã€‚å¿…é¡»ä½¿ç”¨**é” (Lock)** æ¥ä¿è¯æ•°æ®å®‰å…¨ã€‚

#### <span style="color:#a5b1c2;">å®æˆ˜ä»£ç ï¼šä½¿ç”¨ `Lock` ä¿æŠ¤å…±äº«æ•°æ®</span>
```python
import threading

# å…±äº«çš„é“¶è¡Œè´¦æˆ·ä½™é¢
balance = 0
# åˆ›å»ºä¸€ä¸ªé”
lock = threading.Lock()

# æ¨¡æ‹Ÿå–é’±æ“ä½œ
def withdraw(amount):
    global balance
    for _ in range(100000):
        # 1. è·å–é” (å¦‚æœé”å·²è¢«å ç”¨ï¼Œåˆ™åœ¨æ­¤é˜»å¡)
        lock.acquire()
        # --- ä¸´ç•ŒåŒºå¼€å§‹ ---
        balance -= amount 
        # --- ä¸´ç•ŒåŒºç»“æŸ ---
        # 2. é‡Šæ”¾é”
        lock.release()

# æ¨¡æ‹Ÿå­˜é’±æ“ä½œ
def deposit(amount):
    global balance
    for _ in range(100000):
        lock.acquire()
        balance += amount
        lock.release()

t_withdraw = threading.Thread(target=withdraw, args=(10,))
t_deposit = threading.Thread(target=deposit, args=(10,))

t_withdraw.start()
t_deposit.start()
t_withdraw.join()
t_deposit.join()

# ç†æƒ³ç»“æœåº”ä¸º 0ï¼Œå¦‚æœä¸åŠ é”ï¼Œç»“æœä¼šæ˜¯ä¸€ä¸ªéšæœºæ•°
print(f"æœ€ç»ˆä½™é¢: {balance}")
```

---

## <span style="color:#2ecc71;">ç¬¬ä¸‰éƒ¨åˆ†ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼</span>

### <span style="color:#27ae60;">â‘¦ æŒæ¡ç»å…¸å¹¶å‘æ¨¡å‹</span>
è¿™æ˜¯æœ€ç»å…¸çš„å¤šçº¿ç¨‹/å¤šè¿›ç¨‹åä½œæ¨¡å¼ï¼Œç”¨äº**è§£è€¦**ç”Ÿäº§ä»»åŠ¡å’Œæ¶ˆè´¹ä»»åŠ¡ï¼Œå¹³è¡¡ä¸¤è€…çš„é€Ÿåº¦å·®å¼‚ã€‚

> [!NOTE] æ ¸å¿ƒç»„ä»¶
> - **ç”Ÿäº§è€… (Producer)**: è´Ÿè´£åˆ›å»ºæ•°æ®ï¼Œå¹¶æ”¾å…¥å…±äº«çš„â€œ**ç¼“å†²åŒº**â€ã€‚
> - **æ¶ˆè´¹è€… (Consumer)**: è´Ÿè´£ä»â€œ**ç¼“å†²åŒº**â€ä¸­å–å‡ºæ•°æ®ï¼Œå¹¶è¿›è¡Œå¤„ç†ã€‚
> - **ç¼“å†²åŒº (Buffer)**: é€šå¸¸ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„**é˜Ÿåˆ— (`queue.Queue`)** æ¥å®ç°ã€‚

#### <span style="color:#a5b1c2;">å®æˆ˜ä»£ç ï¼šåŸºäº `queue` çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</span>
```python
import threading
import queue
import time
import random

# 1. åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—ä½œä¸ºç¼“å†²åŒº
buffer_queue = queue.Queue(maxsize=5) # ç¼“å†²åŒºæœ€å¤§å®¹é‡ä¸º5

# ç”Ÿäº§è€…çº¿ç¨‹
def producer(name):
    for i in range(10):
        item = f"äº§å“-{i}"
        time.sleep(random.uniform(0.1, 0.5)) # æ¨¡æ‹Ÿç”Ÿäº§è€—æ—¶
        buffer_queue.put(item) # å°†äº§å“æ”¾å…¥ç¼“å†²åŒº
        print(f"ç”Ÿäº§è€… {name} ç”Ÿäº§äº† {item}, å½“å‰åº“å­˜: {buffer_queue.qsize()}")
    print(f"ç”Ÿäº§è€… {name} å®Œæˆç”Ÿäº§ã€‚")

# æ¶ˆè´¹è€…çº¿ç¨‹
def consumer(name):
    while True:
        try:
            # ä»ç¼“å†²åŒºè·å–äº§å“ï¼Œå¦‚æœä¸ºç©ºåˆ™é˜»å¡ç­‰å¾…ï¼Œè®¾ç½®1ç§’è¶…æ—¶
            item = buffer_queue.get(timeout=1) 
            time.sleep(random.uniform(0.2, 0.8)) # æ¨¡æ‹Ÿæ¶ˆè´¹è€—æ—¶
            print(f"æ¶ˆè´¹è€… {name} æ¶ˆè´¹äº† {item}, å‰©ä½™åº“å­˜: {buffer_queue.qsize()}")
            # buffer_queue.task_done() # å¯é€‰ï¼Œç”¨äº q.join()
        except queue.Empty:
            # å¦‚æœé˜Ÿåˆ—åœ¨è¶…æ—¶åä»ç„¶ä¸ºç©ºï¼Œè¯´æ˜å¯èƒ½ç”Ÿäº§ç»“æŸ
            print(f"æ¶ˆè´¹è€… {name} ç­‰å¾…è¶…æ—¶ï¼Œé€€å‡ºã€‚")
            break

# åˆ›å»ºå¹¶å¯åŠ¨çº¿ç¨‹
p = threading.Thread(target=producer, args=("P1",))
c1 = threading.Thread(target=consumer, args=("C1",))
c2 = threading.Thread(target=consumer, args=("C2",))

p.start()
c1.start()
c2.start()

p.join()
c1.join()
c2.join()

print("æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼")
```