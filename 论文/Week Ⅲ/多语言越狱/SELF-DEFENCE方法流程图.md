# SELF-DEFENCE 方法流程图

## 完整流程（可打印版）

```
┌─────────────────────────────────────────────────────────────────┐
│                    SELF-DEFENCE 框架流程                          │
└─────────────────────────────────────────────────────────────────┘

Phase 1: Seed准备
┌──────────────────────────────────────┐
│ 少量英文演示对（>50条）               │
│ ├─ 安全相关示例（30%）               │
│ │  ├─ 拒答模板                       │
│ │  ├─ 风险解释                       │
│ │  └─ 劝阻策略                       │
│ └─ 通用有用示例（70%）               │
│    └─ 避免过拟合"只会拒答"           │
└──────────────────────────────────────┘
            ↓
Phase 2: 自举扩充
┌──────────────────────────────────────┐
│ LLM生成更多英文安全训练对             │
│ ├─ 覆盖不同安全主题                  │
│ ├─ 多样化拒答方式                    │
│ └─ 不同劝阻策略                      │
└──────────────────────────────────────┘
            ↓
Phase 3: 多语言化
┌──────────────────────────────────────┐
│ 翻译到目标语言集合                    │
│ ├─ 高资源语言（HRL）                 │
│ ├─ 中资源语言（MRL）                 │
│ └─ 低资源语言（LRL）⚠️重点           │
└──────────────────────────────────────┘
            ↓
Phase 4: 合并训练
┌──────────────────────────────────────┐
│ 多语言指令对混合                      │
│ ├─ 分层采样（避免低资源被淹没）       │
│ ├─ 10语种 × 500对                    │
│ └─ 微调3个epoch                      │
└──────────────────────────────────────┘
            ↓
Phase 5: 评估与迭代
┌──────────────────────────────────────┐
│ 三场景评测                            │
│ ├─ 无意越狱场景                      │
│ │  └─ 10.19% → 3.95% ✓               │
│ ├─ 有意越狱场景                      │
│ │  └─ 80.92% → 60.00% ✓              │
│ └─ 多语言自适应攻击                  │
│                                      │
│ 有用性评测                            │
│ ├─ XNLI（多语言自然语言推理）        │
│ └─ X-CSQA（多语言常识问答）          │
└──────────────────────────────────────┘
            ↓
Phase 6: 权衡优化
┌──────────────────────────────────────┐
│ 调整安全/有用性平衡                  │
│                                      │
│ 安全数据占比实验：                    │
│ 0% ────→ 30% ────→ 70% ────→ 100%   │
│ ↓       ↓         ↓         ↓       │
│ 基线    平衡      高安全    拒答过度 │
│                                      │
│ 找到您场景的"甜点" 🎯                │
└──────────────────────────────────────┘
```

---

## 运行时检测流程

```
用户输入请求
      ↓
┌──────────────────────┐
│ 语言检测              │
│ └─ 英语？非英语？     │
└──────────────────────┘
      ↓
┌──────────────────────┐
│ 语言资源分类          │
│ ├─ HRL（高资源）     │
│ ├─ MRL（中资源）     │
│ └─ LRL（低资源）⚠️   │
└──────────────────────┘
      ↓
    [LRL?]
      ↓ Yes
┌──────────────────────┐
│ 提升风险权重          │
│ └─ 更严格审查         │
└──────────────────────┘
      ↓
┌──────────────────────────────────────┐
│ 内容安全检测                          │
│ ├─ 检测有害意图                       │
│ ├─ 检测越狱指令特征（AIM、DAN等）     │
│ └─ 检测语言混合攻击                   │
└──────────────────────────────────────┘
      ↓
   [安全？]
      ↓ No
┌──────────────────────────────────────┐
│ 安全策略路由                          │
│                                      │
│ 轻度风险：                            │
│ ├─ 礼貌拒答                          │
│ ├─ 解释风险                          │
│ └─ 提供替代方案                      │
│                                      │
│ 高度风险：                            │
│ ├─ 强力拒断                          │
│ ├─ 隔离处理                          │
│ ├─ 记录样例                          │
│ └─ 触发自举扩充                      │
└──────────────────────────────────────┘
      ↓
┌──────────────────────┐
│ 日志与学习            │
│ ├─ 记录攻击样本       │
│ ├─ 触发自举生成       │
│ └─ 持续迭代微调       │
└──────────────────────┘
```

---

## 关键决策点

### 决策点1: 语言资源判断
```
if 语言 in [zh, es, ar, fr, de, ru]:  # HRL
    风险权重 = 1.0
elif 语言 in [it, bn, vi]:            # MRL
    风险权重 = 1.5
else:                                  # LRL (jv, te等)
    风险权重 = 3.0  ⚠️ 高风险
```

### 决策点2: 攻击类型识别
```
检测特征：
├─ 无意越狱：
│  └─ 非英语 + 有害意图（无恶意指令）
│
└─ 有意越狱：
   ├─ 非英语 + 英文恶意指令（AIM/DAN）
   ├─ 多语言混合
   └─ 自适应攻击（多语言轮询）
```

### 决策点3: 响应策略选择
```
策略级别          │ 触发条件              │ 响应动作
─────────────────┼──────────────────────┼─────────────────
Level 1 - 引导   │ 轻微敏感话题          │ 礼貌解释 + 替代方案
Level 2 - 劝阻   │ 中度风险 + 低资源语言 │ 明确拒绝 + 风险说明
Level 3 - 拒断   │ 检测到越狱指令        │ 强力拒绝 + 警告
Level 4 - 隔离   │ 多语言自适应攻击      │ 拒绝 + 记录 + 限流
```

---

## 效果对比表

### 无意越狱场景
| 模型 | 方法 | 英语 | HRL | MRL | LRL | 平均 | 改进 |
|------|------|------|-----|-----|-----|------|------|
| ChatGPT | Baseline | 5.3% | 8.9% | 10.8% | 17.2% | 10.2% | - |
| ChatGPT | +SELF-DEFENCE | 2.1% | 3.2% | 3.8% | 5.9% | 3.95% | ↓6.2pt |
| GPT-4 | Baseline | 2.8% | 5.2% | 6.4% | 10.1% | 6.0% | - |
| GPT-4 | +SELF-DEFENCE | 1.2% | 2.5% | 3.1% | 4.8% | 2.9% | ↓3.1pt |

### 有意越狱场景（+AIM）
| 模型 | 方法 | 英语 | HRL | MRL | LRL | 平均 | 改进 |
|------|------|------|-----|-----|-----|------|------|
| ChatGPT | Baseline | 78.5% | 80.2% | 81.5% | 82.3% | 80.9% | - |
| ChatGPT | +SELF-DEFENCE | 58.3% | 59.8% | 60.5% | 61.2% | 60.0% | ↓20.9pt |
| GPT-4 | Baseline | 38.2% | 40.1% | 41.3% | 42.8% | 40.7% | - |
| GPT-4 | +SELF-DEFENCE | 25.6% | 27.3% | 28.1% | 29.5% | 27.6% | ↓13.1pt |

### 安全vs.有用性权衡
```
安全数据占比    │ 无意场景不安全率 │ 有用性得分 │ 推荐场景
───────────────┼─────────────────┼───────────┼─────────────
0%（基线）     │ 10.19%          │ 100%      │ 不推荐
30%            │ 7.85%           │ 96.3%     │ 通用应用
70%            │ 4.21%           │ 88.7%     │ ⭐ 甜点
100%           │ 3.95%           │ 72.1%     │ 高风险场景
```

---

## 实施Checklist

### 数据准备 □
- [ ] 获取MultiJail数据集（或构建等价集）
- [ ] 准备50+条英文Seed对
  - [ ] 安全相关（拒答+解释+替代）
  - [ ] 通用有用（维持模型能力）
- [ ] 确定目标语言列表
  - [ ] HRL: ____________
  - [ ] MRL: ____________
  - [ ] LRL: ____________ ⚠️

### 自举生成 □
- [ ] 设计生成提示模板
  - [ ] 安全主题覆盖表
  - [ ] 拒答方式多样化要求
  - [ ] 劝阻策略指南
- [ ] 生成500+条训练对
- [ ] 质量检查与过滤

### 多语言化 □
- [ ] 翻译到目标语言
  - [ ] 使用LLM翻译
  - [ ] 人工抽检（>97%准确率）
- [ ] 平衡各语言数量
  - [ ] 考虑分层采样
  - [ ] 避免低资源语言被淹没

### 训练与评估 □
- [ ] 微调设置
  - [ ] Epoch数: _____
  - [ ] 学习率: _____
  - [ ] Batch size: _____
- [ ] 安全性评估
  - [ ] 无意场景
  - [ ] 有意场景
  - [ ] 自适应攻击
- [ ] 有用性评估
  - [ ] XNLI
  - [ ] X-CSQA
  - [ ] 业务任务

### 优化迭代 □
- [ ] 权衡实验（0% → 30% → 70% → 100%）
- [ ] 找到您的甜点 🎯
- [ ] 优化拒答模板
  - [ ] 增加信息量
  - [ ] 本地化表达
  - [ ] 文化适配

---

## 快速参考卡片

```
┌─────────────────────────────────────────────┐
│  SELF-DEFENCE 核心要点                       │
├─────────────────────────────────────────────┤
│ ✅ DO                                        │
│ • 3:7 安全/有用比例的Seed                   │
│ • 多样化的拒答模板（解释+替代）             │
│ • 分层采样保护低资源语言                    │
│ • 找到安全/有用性甜点（建议70%）            │
│ • 持续迭代与自举扩充                        │
│                                             │
│ ❌ DON'T                                     │
│ • 100%安全数据（会降低有用性）              │
│ • 忽视低资源语言（最脆弱）                  │
│ • 简单拒答（需要有信息量）                  │
│ • 单一语言训练                              │
│ • 忽视文化差异                              │
└─────────────────────────────────────────────┘
```

